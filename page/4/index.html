<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="learn, love, sport, life">
<meta property="og:type" content="website">
<meta property="og:title" content="witness daily">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="witness daily">
<meta property="og:description" content="learn, love, sport, life">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="witness">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>witness daily</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="witness daily" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">witness daily</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>Sitemap</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/02/dynamic-programming-%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/02/dynamic-programming-%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/" class="post-title-link" itemprop="url">dynamic_programming_最长回文子串</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-02 17:10:12" itemprop="dateCreated datePublished" datetime="2021-06-02T17:10:12+08:00">2021-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:48:08" itemprop="dateModified" datetime="2021-07-07T13:48:08+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
                </span>
            </span>

          
            <span id="/2021/06/02/dynamic-programming-%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/" class="post-meta-item leancloud_visitors" data-flag-title="dynamic_programming_最长回文子串" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/02/dynamic-programming-%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/02/dynamic-programming-%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210624142408146.png" alt="image-20210624142408146"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLongestPalindrome</span><span class="params">(String A, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// write code here</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n][n];</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="comment">// </span></span><br><span class="line">                <span class="keyword">if</span> (i == j) &#123;</span><br><span class="line">                    dp[i][j] = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 状态转移</span></span><br><span class="line">                <span class="keyword">if</span> (j - i &gt; <span class="number">1</span> &amp;&amp; !dp[i + <span class="number">1</span>][j - <span class="number">1</span>]) &#123;</span><br><span class="line">                    dp[i][j] = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (A.charAt(i) == A.charAt(j)) &#123;</span><br><span class="line">                        dp[i][j] = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        dp[i][j] = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (dp[i][j]) &#123;</span><br><span class="line">                    res = Math.max(res, j - i + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/02/JMH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/02/JMH/" class="post-title-link" itemprop="url">JMH</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-02 08:46:36" itemprop="dateCreated datePublished" datetime="2021-06-02T08:46:36+08:00">2021-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:47:23" itemprop="dateModified" datetime="2021-07-07T13:47:23+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
                </span>
            </span>

          
            <span id="/2021/06/02/JMH/" class="post-meta-item leancloud_visitors" data-flag-title="JMH" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/02/JMH/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/02/JMH/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess/1.21">https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess/1.21</a></p>
<p>上maven仓库找到</p>
<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210629165706452.png" alt="image-20210629165706452"></p>
<h2 id="在maven项目中pom-xml中配置"><a href="#在maven项目中pom-xml中配置" class="headerlink" title="在maven项目中pom.xml中配置"></a>在maven项目中pom.xml中配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-core --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210629170251770.png" alt="image-20210629170251770"></p>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Benchmark</span> </span><br><span class="line"><span class="meta">@Warmup(iterations = 1, time = 3)</span>  <span class="comment">// 预热</span></span><br><span class="line"><span class="meta">@Fork(5)</span> <span class="comment">// 开多少个线程去执行</span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.Throughput)</span>  <span class="comment">// 测试的模式  吞吐量</span></span><br><span class="line"> <span class="meta">@Measurement(iterations = 1, time = 3)</span>  <span class="comment">// 调用这个方法多少次</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testForEach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PS.foreach();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/22/latex-%E4%B8%89%E7%BA%BF%E8%A1%A8%E5%88%B6%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/22/latex-%E4%B8%89%E7%BA%BF%E8%A1%A8%E5%88%B6%E4%BD%9C/" class="post-title-link" itemprop="url">三线表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-22 15:53:35" itemprop="dateCreated datePublished" datetime="2021-05-22T15:53:35+08:00">2021-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:48:11" itemprop="dateModified" datetime="2021-07-07T13:48:11+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/latex/" itemprop="url" rel="index"><span itemprop="name">latex</span></a>
                </span>
            </span>

          
            <span id="/2021/05/22/latex-%E4%B8%89%E7%BA%BF%E8%A1%A8%E5%88%B6%E4%BD%9C/" class="post-meta-item leancloud_visitors" data-flag-title="三线表" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/05/22/latex-%E4%B8%89%E7%BA%BF%E8%A1%A8%E5%88%B6%E4%BD%9C/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/05/22/latex-%E4%B8%89%E7%BA%BF%E8%A1%A8%E5%88%B6%E4%BD%9C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;table&#125;</span><br><span class="line"><span class="keyword">\begin</span>&#123;center&#125;</span><br><span class="line"><span class="keyword">\caption</span>&#123;Performance evaluated on the test-dev and test-std splits of the VQA-v2 dataset. The proposed method is compared with several state-of-the-art methods. The best results are in bold.&#125;</span><br><span class="line"> <span class="keyword">\label</span>&#123;tbl:sota&#125;</span><br><span class="line"><span class="keyword">\begin</span>&#123;tabular&#125;&#123;lC&#123;1.5cm&#125;C&#123;1.5cm&#125;C&#123;1.5cm&#125;C&#123;1.5cm&#125;C&#123;1.5cm&#125;&#125; <span class="comment">% 控制表格的格式</span></span><br><span class="line"><span class="keyword">\toprule</span></span><br><span class="line"><span class="keyword">\multirow</span>&#123;2&#125;&#123;*&#125;&#123;<span class="keyword">\textbf</span>&#123;Method&#125;&#125; <span class="built_in">&amp;</span> <span class="keyword">\multicolumn</span>&#123;4&#125;&#123;c&#125;&#123;<span class="keyword">\textbf</span>&#123;Test-std&#125;&#125; <span class="built_in">&amp;</span> <span class="keyword">\multicolumn</span>&#123;1&#125;&#123;c&#125;&#123;<span class="keyword">\textbf</span>&#123;Test-std&#125;&#125; <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\specialrule</span>&#123;0em&#125;&#123;1pt&#125;&#123;1pt&#125;</span><br><span class="line"><span class="keyword">\cline</span>&#123;2-6&#125;  </span><br><span class="line"><span class="keyword">\specialrule</span>&#123;0em&#125;&#123;2pt&#125;&#123;2pt&#125;</span><br><span class="line"> <span class="built_in">&amp;</span>   <span class="keyword">\textbf</span>&#123;Yes/No&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;Number&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;Other&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;All&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;All&#125; <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\midrule</span></span><br><span class="line">BUTD <span class="keyword">\cite</span>&#123;anderson2018bottom&#125; <span class="built_in">&amp;</span> 81.82 <span class="built_in">&amp;</span> 44.21 <span class="built_in">&amp;</span> 56.05 <span class="built_in">&amp;</span> 65.32 <span class="built_in">&amp;</span> 65.37 <span class="keyword">\\</span></span><br><span class="line">DFAF <span class="keyword">\cite</span>&#123;gao2019dynamic&#125;  <span class="built_in">&amp;</span> 86.09 <span class="built_in">&amp;</span> 53.32 <span class="built_in">&amp;</span> 60.49 <span class="built_in">&amp;</span> 70.22 <span class="built_in">&amp;</span> 70.34 <span class="keyword">\\</span></span><br><span class="line">MLIN <span class="keyword">\cite</span>&#123;gao2019multi&#125;  <span class="built_in">&amp;</span> 85.96 <span class="built_in">&amp;</span> 52.93 <span class="built_in">&amp;</span> 60.49 <span class="built_in">&amp;</span> 70.18 <span class="built_in">&amp;</span> 70.28 <span class="keyword">\\</span></span><br><span class="line">MCAN <span class="keyword">\cite</span>&#123;yu2019deep&#125;  <span class="built_in">&amp;</span> 87.06 <span class="built_in">&amp;</span> 53.26 <span class="built_in">&amp;</span> 60.66 <span class="built_in">&amp;</span> 70.63 <span class="built_in">&amp;</span> 70.90 <span class="keyword">\\</span></span><br><span class="line">SelRes <span class="keyword">\cite</span>&#123;hong2020selective&#125;  <span class="built_in">&amp;</span> 86.74 <span class="built_in">&amp;</span> 53.05 <span class="built_in">&amp;</span> 60.47 <span class="built_in">&amp;</span> 70.45 <span class="built_in">&amp;</span> 70.74 <span class="keyword">\\</span></span><br><span class="line">RA <span class="keyword">\cite</span>&#123;guo2020re&#125; <span class="built_in">&amp;</span> 87.00 <span class="built_in">&amp;</span> 53.06 <span class="built_in">&amp;</span> 60.19 <span class="built_in">&amp;</span> 70.43 <span class="built_in">&amp;</span> 70.72 <span class="keyword">\\</span></span><br><span class="line">MESAN <span class="keyword">\cite</span>&#123;guo2020multi&#125;  <span class="built_in">&amp;</span> 87.05 <span class="built_in">&amp;</span> 53.21 <span class="built_in">&amp;</span> 60.72 <span class="built_in">&amp;</span> 71.71 <span class="built_in">&amp;</span> 71.08 <span class="keyword">\\</span></span><br><span class="line">MEDAN <span class="keyword">\cite</span>&#123;chen2020multimodal&#125;  <span class="built_in">&amp;</span> 86.90 <span class="built_in">&amp;</span> 52.83 <span class="built_in">&amp;</span> 60.67 <span class="built_in">&amp;</span> 70.59 <span class="built_in">&amp;</span> 70.91 <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\midrule</span></span><br><span class="line">FAIN (ours) <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;87.07&#125; <span class="built_in">&amp;</span> 53.19 <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;60.77&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;70.76&#125; <span class="built_in">&amp;</span> <span class="keyword">\textbf</span>&#123;70.76&#125;  <span class="keyword">\\</span></span><br><span class="line">  <span class="keyword">\bottomrule</span></span><br><span class="line">  <span class="keyword">\end</span>&#123;tabular&#125;</span><br><span class="line">  <span class="keyword">\end</span>&#123;center&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;table&#125;</span><br></pre></td></tr></table></figure>


<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210527203926891.png" alt="image-20210527203926891"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/20/latex-ack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/20/latex-ack/" class="post-title-link" itemprop="url">添加ACK</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-20 15:53:35" itemprop="dateCreated datePublished" datetime="2021-05-20T15:53:35+08:00">2021-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:48:11" itemprop="dateModified" datetime="2021-07-07T13:48:11+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/latex/" itemprop="url" rel="index"><span itemprop="name">latex</span></a>
                </span>
            </span>

          
            <span id="/2021/05/20/latex-ack/" class="post-meta-item leancloud_visitors" data-flag-title="添加ACK" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/05/20/latex-ack/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/05/20/latex-ack/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>spring模板未提供ack模板，但是需要加上</p>
<h1 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h1><p>\subsubsection*{Acknowledgements.}</p>
<h1 id="附加"><a href="#附加" class="headerlink" title="附加"></a>附加</h1><p>\textcolor{blue}{This work is supported in part by the National Natural Science Foundation of China under grant No.U1711261 and the Guangdong Major Project of Basic and Applied Basic Research under grant No.2019B030302002.}</p>
<p>可以使字体变蓝</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/20/latex-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%E9%A1%BA%E5%BA%8F%E4%BF%AE%E6%94%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/20/latex-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%E9%A1%BA%E5%BA%8F%E4%BF%AE%E6%94%B9/" class="post-title-link" itemprop="url">参考文献顺序修改</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-20 15:53:35" itemprop="dateCreated datePublished" datetime="2021-05-20T15:53:35+08:00">2021-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:48:11" itemprop="dateModified" datetime="2021-07-07T13:48:11+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/latex/" itemprop="url" rel="index"><span itemprop="name">latex</span></a>
                </span>
            </span>

          
            <span id="/2021/05/20/latex-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%E9%A1%BA%E5%BA%8F%E4%BF%AE%E6%94%B9/" class="post-meta-item leancloud_visitors" data-flag-title="参考文献顺序修改" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/05/20/latex-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%E9%A1%BA%E5%BA%8F%E4%BF%AE%E6%94%B9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/05/20/latex-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%E9%A1%BA%E5%BA%8F%E4%BF%AE%E6%94%B9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>原来使用spring的模板会让参考文献按照首字母排序，但是会议要求正文引用顺序排序</p>
<h1 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h1><p>在<strong>splncs04.bst</strong>找到  <strong>SORT</strong> ，并删除即可</p>
<p>这里注意 SORT 只有一行，大写的一行</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/27/redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/redis/" class="post-title-link" itemprop="url">redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-27 21:46:36" itemprop="dateCreated datePublished" datetime="2021-04-27T21:46:36+08:00">2021-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:47:35" itemprop="dateModified" datetime="2021-07-07T13:47:35+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
                </span>
            </span>

          
            <span id="/2021/04/27/redis/" class="post-meta-item leancloud_visitors" data-flag-title="redis" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/27/redis/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/27/redis/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="redis入门"><a href="#redis入门" class="headerlink" title="redis入门"></a>redis入门</h1><ul>
<li>redis是一款基于键值对的nosql数据库，键都是字符串，他的值支持多种数据结构：字符串 哈希 列表 集合  有序集合</li>
<li>将所有的数据都存放在内存中，所以读写性能惊人，同时，redis还可以将内存中的数据以快照（几个小时做一次，恢复快）或日志（aof，实时的存，恢复的慢）的形式保存到硬盘上，以保证数据的安全性。</li>
<li>redis典型的应用场景包括：缓存、排行榜、计数器、社交网络、消息队列等</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/26/lecture-3-GFS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/26/lecture-3-GFS/" class="post-title-link" itemprop="url">GFS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-26 08:46:36" itemprop="dateCreated datePublished" datetime="2021-04-26T08:46:36+08:00">2021-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:47:40" itemprop="dateModified" datetime="2021-07-07T13:47:40+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
                </span>
            </span>

          
            <span id="/2021/04/26/lecture-3-GFS/" class="post-meta-item leancloud_visitors" data-flag-title="GFS" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/26/lecture-3-GFS/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/26/lecture-3-GFS/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-分布式存储系统的难点"><a href="#1-分布式存储系统的难点" class="headerlink" title="1 分布式存储系统的难点"></a>1 分布式存储系统的难点</h1><p>之所以要说存储，原因是，存储是一种关键的抽象。你可以想象，在分布式系统中，可能有各种各样重要的抽象可以应用在分布式系统中，但是实际上，简单的存储接口往往非常有用且极其通用。所以，构建分布式系统大多都是关于如何设计存储系统，或是设计其它基于大型分布式存储的系统。所以我们会更加关注如何为大型分布式存储系统设计一个优秀的接口，以及如何设计存储系统的内部结构，这样系统才能良好运行。通过阅读GFS论文，我们可以开始了解到这是怎么做到的。</p>
<p>人们设计大型分布式系统或大型存储系统出发点通常是，他们想获取巨大的性能加成，进而利用数百台计算机的资源来同时完成大量工作。因此，性能问题就成为了最初的诉求。 之后<strong>，很自然的想法就是将数据分割放到大量的服务器上，这样就可以并行的从多台服务器读取数据。我们将这种方式称之为分片（Sharding）</strong>。</p>
<p>如果你在成百上千台服务器进行分片，你将会看见常态的故障。如果你有数千台服务器，那么总是会有一台服务器宕机，每天甚至每个小时都可能会发生错误。所以，<strong>我们需要自动化的方法而不是人工介入来修复错误。我们需要一个自动的容错系统，这就引出了容错这个话题（fault tolerance）</strong>。</p>
<p>实现容错最有用的一种方法是使用复制，只需要维护2-3个数据的副本，当其中一个故障了，你就可以使用另一个。所以，<strong>如果想要容错能力，就得有复制（replication）</strong>。</p>
<p>如果有复制，那就有了两份数据的副本。可以确定的是，如果你不小心，它们就会不一致。所以，你本来设想的是，有了两个数据副本，你可以任意使用其中一个副本来容错。但是如果你不够小心，两个数据的副本就不是完全一致，严格来说，它们就不再互为副本了。而你获取到的数据内容也将取决于你向哪个副本请求数据。这对于应用程序来说就有些麻烦了。所以<strong>，如果我们有了复制，我们就有不一致的问题（inconsistency）</strong>。</p>
<p>通过聪明的设计，你可以避免不一致的问题，并且让数据看起来也表现的符合预期。但是为了达到这样的效果，你总是需要额外的工作，需要不同服务器之间通过网络额外的交互，而这样的交互会降低性能。所以如果你想要一致性，你的代价就是低性能。但这明显不是我们最开始所希望的</p>
<p>当然，这里并不是绝对的。你可以构建性能很高的系统，但是不可避免的，都会陷入到这里的循环来。现实中，如果你想要好的一致性，你就要付出相应的代价。如果你不想付出代价，那就要忍受一些不确定的行为。我们之后会在很多系统中看到这里介绍的循环。通常，人们很少会乐意为好的一致性付出相应的性能代价。</p>
<h1 id="2-错误的设计（bad-design）"><a href="#2-错误的设计（bad-design）" class="headerlink" title="2 错误的设计（bad design）"></a>2 错误的设计（bad design）</h1><p>这里说到了一致性，我在后面的课程会对“好”的一致性做更多的介绍（lec6-7）。对于<strong>具备强一致或者好的一致性的系统，从应用程序或者客户端看起来就像是和一台服务器在通信</strong>。尽管我们会通过数百台计算机构建一个系统，但是<strong>对于一个理想的强一致模型，你看到的就像是只有一台服务器，一份数据，并且系统一次只做一件事情</strong>。这是一种直观的理解强一致的方式。你可以认为只有一台服务器，甚至这个服务器只运行单线程，它同一时间只处理来自客户端的一个请求。这很重要，因为可能会有大量的客户端并发的发送请求到服务器上。这里要求服务器从请求中挑选一个出来先执行，执行完成之后再执行下一个。</p>
<p>对于存储服务器来说，它上面会有一块磁盘。执行一个写请求或许意味着向磁盘写入一个数据或者对数据做一次自增。如果这是一次修改操作，并且我们有一个以key-value为索引的数据表单，那么我们会修改这个表单。如果是一次读取操作，我们只需要将之前写入的数据，从表单中取出即可。</p>
<p>为了让这里的简单服务有可预期的行为，需要定义一条规则：一个时间只执行一条请求。这样每个请求都可以看到之前所有请求按照顺序执行生成的数据。所以，如果有一些写请求，并且服务器以某种顺序一次一个的处理了它们，当你从服务器读数据时，你可以看到期望的数据。这里的解释不是很直观，你可以通过下面的例子去理解。</p>
<p>例如，我们有一些客户端，客户端C1发起写请求将X设置成1。在同一时刻，客户端C2发起写请求将X设置成2。过了一会，在C1和C2的写请求都执行完毕之后，客户端C3会发送读取X的请求，并得到了一个结果。客户端C4也会发送读取X的请求，也得到了一个结果。现在的问题是，这两个客户端看到的结果是什么？</p>
<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210426161513801.png" alt="image-20210426161513801"></p>
<p>我这里提出这个场景的目的是为了展示，即使在一个非常简单的系统中，仍然会出现一些模糊的场景使得你不知道系统的执行过程以及输出结果。你能做的只是从产生的结果来判断系统的输出是一致性还是非一致性。</p>
<p>如果C3读X得到2，那么C4最好也是读X得到2，因为在我们的例子中，C3读X得到2意味着，写X为2的请求必然是第二个执行的写请求。当C4读X时，写X为2应该仍然是第二个写请求。希望这里完全直观的介绍清楚了有关强一致的一个模型</p>
<p>当然，这里的问题是，因为<strong>只有单个服务器，所以容错能力很差</strong>。如果服务器故障了，磁盘坏了，系统整个就不可用了。所以，在现实世界中，我们会<strong>构建多副本的分布式系统</strong>，但这却又是所有问题的开始。</p>
<p>这里有一个几乎是最糟糕的多副本设计，我提出它是为了让你们知道问题所在，并且同样的问题在GFS中也存在。这个设计是这样，我们有两台服务器，每个服务器都有数据的一份完整拷贝。它们在磁盘上都存储了一个key-value表单。当然，直观上我们希望这两个表单是完全一致的，这样，一台服务器故障了，我们可以切换到另一台服务器去做读写。</p>
<p><strong>两个表单完全一致意味着，每一个写请求都必须在两台服务器上执行，而读请求只需要在一台服务器上执行，否则就没有容错性了</strong>。因为如果读请求也需要从两台服务器读数据，那么一台服务器故障我们就没法提供服务了。现在问题来了，假设客户端C1和C2都想执行写请求，其中一个要写X为1，另一个写X为2。C1会将写X为1的请求发送个两个服务器，因为我们想要更新两台服务器上的数据。C2也会将写X为2的请求发送给两个服务器。</p>
<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210426161722869.png" alt="image-20210426161722869"></p>
<p>这里会出现什么错误呢？是的，我们没有做任何事情来保障两台服务器以相同的顺序处理这2个请求。这个设计真不咋样。如果服务器1（S1）先处理C1的请求，那么在它的表单里面，X先是1，之后S1看到了来自C2的请求，会将自己表单中的X覆盖成2。但是，如果S2恰好以不同的顺序收到客户端请求，那么S2会先执行C2的请求，将X设置为2，之后收到C1的请求，将X设置为1。</p>
<p>之后，如果另外一些客户端，假设C3从S1读数据，C4从S2读数据，我们就会面临一个可怕的场景：这两个客户端读取的数据不一样。但是从前一个例子中的简单模型可以看出，相连的读请求应该读出相同的数据。</p>
<p>之后，如果另外一些客户端，假设C3从S1读数据，C4从S2读数据，我们就会面临一个可怕的场景：这两个客户端读取的数据不一样。但是从前一个例子中的简单模型可以看出，相连的读请求应该读出相同的数据。</p>
<p>这里的问题可以以另一种方式暴露出来。假设我们尝试修复上面的问题，我们让客户端在S1还在线的时候，只从S1读取数据，S1不在线了再从S2读取数据。这样最开始所有的客户端读X都能得到2。但是突然，如果S1故障了，尽管没有写请求将X改成1，客户端读X得到的数据将会从2变成1。因为S1故障之后，所有的客户端都会切换到S2去读数据。这种数据的神奇变化与任何写操作都没有关联，并且也不可能在前一个例子的简单模型中发生。</p>
<p>当然，这里的问题是可以修复的，修复需要服务器之间更多的通信，并且复杂度也会提升。由于获取强一致会带来不可避免的复杂性的提升，有<strong>大量的方法可以在好的一致性和一些小瑕疵行为之间追求一个平衡。</strong></p>
<h1 id="GFS的设计目标"><a href="#GFS的设计目标" class="headerlink" title="GFS的设计目标"></a>GFS的设计目标</h1><p>Google拥有远超过单个磁盘容量的数据，例如从整个互联网爬出来的网页，YouTube视频，用来构建搜索索引的中间文件，Web服务器中的大量日志文件等。所以，Google有大量的数据，需要大量的磁盘来存储这些数据，并且需要能借助MapReduce这样的工具来快速处理这些数据。所以，Google需要能够快速的并行访问这些海量数据。</p>
<p>Google的目标是构建一个<strong>大型的，快速的文件系统</strong>。并且这个<strong>文件系统是全局有效的</strong>，这样各种不同的应用程序都可以从中读取数据。一种构建大型存储系统的方法是针对某个特定的应用程序构建特定的裁剪的存储系统。但是如果另一个应用程序也想要一个大型存储系统，那么又需要重新构建一个存储系统。如果有一个全局通用的存储系统，那就意味着如果我存储了大量从互联网抓取的数据，你也可以通过申请权限来查看这些数据，因为我们都使用了同一个存储系统。这样，任何在Google内部的人员都可以根据名字读取这个文件系统（GFS）中可被共享的内容。</p>
<p>为了获得<strong>大容量和高速的特性，每个包含了数据的文件会被GFS自动的分割并存放在多个服务器之上，这样读写操作自然就会变得很快。因为可以从多个服务器上同时读取同一个文件，进而获得更高的聚合吞吐量。</strong>将文件分割存储还可以在存储系统中保存比单个磁盘还要大的文件。</p>
<p>因为我们现在在数<strong>百台服务器之上构建存储系统，我们希望有自动的故障修复</strong>。我们不希望每次服务器出了故障，派人到机房去修复服务器或者迁移数据。我们希望系统能自动修复自己。</p>
<p>还有一些特征并非是设计目标。比如GFS被设计成只在一个数据中心运行，所以这里并没有将副本保存在世界各地，单个GFS只存在于单个数据中心的单个机房里。理论上来说，数据的多个副本应该彼此之间隔的远一些，但是实现起来挺难的，所以GFS局限在一个数据中心内。</p>
<p>其次，GFS并不面向普通的用户，这是一个Google内部使用的系统，供Google的工程师写应用程序使用。所以Google并没有售卖GFS，它或许售卖了基于GFS的服务，但是GFS并不直接面向普通用户。</p>
<p>第三，GFS在各个方面对大型的顺序文件读写做了定制。在存储系统中有一个完全不同的领域，这个领域只对小份数据进行优化。例如一个银行账户系统就需要一个能够读写100字节的数据库，因为100字节就可以表示人们的银行账户。但是GFS不是这样的系统，<strong>GFS是为TB级别的文件而生。并且GFS只会顺序处理，不支持随机访问</strong>。某种程度上来说，它有点像批处理的风格。GFS并没有花费过多的精力来降低延迟，它的关注点在于巨大的吞吐量上，所以单次操作都涉及到MB级别的数据。</p>
<p>论文也提出了一个当时非常异类的观点：<strong>存储系统具有弱一致性也是可以的</strong>。当时，学术界的观念认为，存储系统就应该有良好的行为，如果构建了一个会返回错误数据的系统，就像前面（详见3.2）介绍的糟糕的多副本系统一样，那还有什么意义？为什么不直接构建一个能返回正确数据的系统？GFS并不保证返回正确的数据，借助于这一点，GFS的目标是提供更好的性能。</p>
<h1 id="GFS-master节点"><a href="#GFS-master节点" class="headerlink" title="GFS master节点"></a>GFS master节点</h1><p>假设我们有上百个客户端和一个Master节点。尽管实际中可以拿多台机器作为Master节点，但是<strong>GFS中Master是Active-Standby模式，所以只有一个Master节点在工作</strong>。Master节点保存了文件名和存储位置的对应关系。除此之外，还有大量的Chunk服务器，可能会有数百个，每一个Chunk服务器上都有1-2块磁盘</p>
<p><strong>Master节点用来管理文件和Chunk的信息，而Chunk服务器用来存储实际的数据</strong>。这是GFS设计中比较好的一面，它将这两类数据的管理问题几乎完全隔离开了，这样这两个问题可以使用独立设计来解决。<strong>Master节点知道每一个文件对应的所有的Chunk的ID，这些Chunk每个是64MB大小，它们共同构成了一个文件</strong>。<strong>如果我有一个1GB的文件，那么Master节点就知道文件的第一个Chunk存储在哪，第二个Chunk存储在哪</strong>，等等。<strong>当我想读取这个文件中的任意一个部分时，我需要向Master节点查询对应的Chunk在哪个服务器上，之后我可以直接从Chunk服务器读取对应的Chunk数据</strong>。</p>
<p>更进一步，我们看一下<strong>GFS的一致性以及GFS是如何处理故障</strong>。为了了解这些，我们需要知道Master节点内保存的数据内容，这里我们关心的主要是两个表单</p>
<ul>
<li>文件名到chunkid或者chunk handle数组的对应。这个表单告诉你，文件对应了哪些Chunk。</li>
<li>第二个表单记录了Chunk ID到Chunk数据的对应关系。这里的数据又包括了<ul>
<li>每个chunk存储在哪些服务器上，所以这部分是chunk服务器的列表</li>
<li>每个chunk当前的版本号，所以master节点必须记住每个chunk对应的版本号</li>
<li>所有对于chunk的写操作都必须在主chunk上顺序处理，主chunk是chunk的多个副本之一，所以，master必须记住哪个chunk服务器持有主chunk</li>
<li>主chunk只能在特定的租约时间内担任主chunk，master节点要记住主chunk的租约时间。</li>
</ul>
</li>
</ul>
<p>以上<strong>数据都存储在内存中，如果Master故障了，这些数据就都丢失了。为了能让Master重启而不丢失数据，Master节点会同时将数据存储在磁盘上</strong>。所以Master节点读数据只会从内存读，但是写数据的时候，至少有一部分数据会接入到磁盘中。更具体来说，Master会在磁盘上存储log，每次有数据变更时，Master会在磁盘的log中追加一条记录，并生成CheckPoint（类似于备份点）。</p>
<p>有些数据需要存在磁盘上，而有些不用。它们分别是：</p>
<ul>
<li>Chunk Handle的数组（第一个表单）要保存在磁盘上。我给它标记成NV（non-volatile, 非易失），这个标记表示对应的数据会写入到磁盘上。</li>
<li>Chunk服务器列表不用保存到磁盘上。因为Master节点重启之后可以与所有的Chunk服务器通信，并查询每个Chunk服务器存储了哪些Chunk，所以我认为它不用写入磁盘。所以这里标记成V（volatile），</li>
<li>版本号要不要写入磁盘取决于GFS是如何工作的，我认为它需要写入磁盘。我们之后在讨论系统是如何工作的时候再详细讨论这个问题。这里先标记成NV。</li>
<li>主Chunk的ID，几乎可以确定不用写入磁盘，因为Master节点重启之后会忘记谁是主Chunk，它只需要等待60秒租约到期，那么它知道对于这个Chunk来说没有主Chunk，这个时候，Master节点可以安全指定一个新的主Chunk。所以这里标记成V。</li>
<li>类似的，租约过期时间也不用写入磁盘，所以这里标记成V。</li>
</ul>
<p>任何时候，如果文件扩展到达了一个新的64MB，需要新增一个Chunk或者由于指定了新的主Chunk而导致版本号更新了，Master节点需要向磁盘中的Log追加一条记录说，我刚刚向这个文件添加了一个新的Chunk或者我刚刚修改了Chunk的版本号。所以每次有这样的更新，都需要写磁盘。GFS论文并没有讨论这么多细节，但是因为写磁盘的速度是有限的，写磁盘会导致Master节点的更新速度也是有限的，所以要尽可能少的写入数据到磁盘。</p>
<p>这里在磁盘中维护log而不是数据库的原因是，数据库本质上来说是某种B树（b-tree）或者hash table，相比之下，追加log会非常的高效，因为你可以将最近的多个log记录一次性的写入磁盘。因为这些数据都是向同一个地址追加，这样只需要等待磁盘的磁碟旋转一次。而对于B树来说，每一份数据都需要在磁盘中随机找个位置写入。所以使用Log可以使得磁盘写入更快一些。</p>
<p>当Master节点故障重启，并重建它的状态，你不会想要从log的最开始重建状态，因为log的最开始可能是几年之前，所以Master节点会在磁盘中创建一些checkpoint点，这可能要花费几秒甚至一分钟。这样Master节点重启时，会从log中的最近一个checkpoint开始恢复，再逐条执行从Checkpoint开始的log，最后恢复自己的状态。</p>
<h1 id="GFS读文件"><a href="#GFS读文件" class="headerlink" title="GFS读文件"></a>GFS读文件</h1><p>对于读请求来说，意味着应用程序或者GFS客户端有一个文件名和它想从文件的某个位置读取的偏移量（offset），应用程序会将这些信息发送给Master节点。Master节点会从自己的file表单中查询文件名，得到Chunk ID的数组。因为每个Chunk是64MB，所以偏移量除以64MB就可以从数组中得到对应的Chunk ID。之后Master再从Chunk表单中找到存有Chunk的服务器列表，并将列表返回给客户端。所以，第一步是客户端（或者应用程序）将文件名和偏移量发送给Master。第二步，Master节点将Chunk Handle（也就是ID，记为H）和服务器列表发送给客户端。</p>
<p>现在客户端可以从这些Chunk服务器中挑选一个来读取数据。GFS论文说，客户端会选择一个网络上最近的服务器（Google的数据中心中，IP地址是连续的，所以可以从IP地址的差异判断网络位置的远近），并将读请求发送到那个服务器。因为客户端每次可能只读取1MB或者64KB数据，所以，客户端可能会连续多次读取同一个Chunk的不同位置。所以，客户端会缓存Chunk和服务器的对应关系，这样，当再次读取相同Chunk数据时，就不用一次次的去向Master请求相同的信息。</p>
<p>接下来，客户端会与选出的Chunk服务器通信，将Chunk Handle和偏移量发送给那个Chunk服务器。Chunk服务器会在本地的硬盘上，将每个Chunk存储成独立的Linux文件，并通过普通的Linux文件系统管理。并且可以推测，Chunk文件会按照Handle（也就是ID）命名。所以，Chunk服务器需要做的就是根据文件名找到对应的Chunk文件，之后从文件中读取对应的数据段，并将数据返回给客户端。</p>
<blockquote>
<p>学生提问：可以再讲一下第一步吗？</p>
<p>Robert教授：第一步是，应用程序想读取某个特定文件的某个特定的偏移位置上的某段特定长度的数据，比如说第1000到第2000个字节的数据。所以，应用程序将文件名，长度和起始位置发送给Master节点。Master节点会从其file表单中查询文件名并找到包含这个数据段的Chunk，这样可以吗？</p>
<p>学生提问：如果读取的数据超过了一个Chunk怎么办？</p>
<p>Robert教授：我不知道详细的细节。我的印象是，如果应用程序想要读取超过64MB的数据，或者就是2个字节，但是却跨越了Chunk的边界，应用程序会通过一个库来向GFS发送RPC，而这个库会注意到这次读请求会跨越Chunk边界，因此会将一个读请求拆分成两个读请求再发送到Master节点。所以，这里可能是向Master节点发送两次读请求，得到了两个结果，之后再向两个不同的Chunk服务器读取数据。</p>
<p>学生提问：如果客户端有偏移量信息，那可以直接算出来是第几个Chunk吧？</p>
</blockquote>
<blockquote>
<p>Robert教授：客户端可以算出来是哪个Chunk，但是客户端不知道Chunk在哪个服务器上。为了获取服务器信息，客户端需要与Master交互。我不能保证究竟是在哪里决定的要读取的是第几个Chunk。但是可以确定的是，Master节点找到了Chunk对应的ID，并确定了Chunk存储在哪个服务器上。</p>
<p>学生提问：能再介绍一下读数据跨越了Chunk边界的情况吗？</p>
<p>Robert教授：客户端本身依赖了一个GFS的库，这个库会注意到读请求跨越了Chunk的边界 ，并会将读请求拆分，之后再将它们合并起来。所以这个库会与Master节点交互，Master节点会告诉这个库说Chunk7在这个服务器，Chunk8在那个服务器。之后这个库会说，我需要Chunk7的最后两个字节，Chunk8的头两个字节。GFS库获取到这些数据之后，会将它们放在一个buffer中，再返回给调用库的应用程序。Master节点会告诉库有关Chunk的信息，而GFS库可以根据这个信息找到应用程序想要的数据。应用程序只需要确定文件名和数据在整个文件中的偏移量，GFS库和Master节点共同协商将这些信息转换成Chunk。</p>
<p>学生提问：从哪个Chunk服务器读取数据重要吗？</p>
<p>Robert教授：是也不是。概念上讲，它们都是副本。实际上，你可能已经注意到，或者我们之前也说过，不同Chunk服务器上的数据并不一定完全相同。应用程序应该要能够容忍这种情况。所以，实际上，如果从不同的Chunk服务器读取数据，可能会略微不同。GFS论文提到，客户端会尝试从同一个机架或者同一个交换机上的服务器读取数据。</p>
</blockquote>
<h1 id="GFS写文件"><a href="#GFS写文件" class="headerlink" title="GFS写文件"></a>GFS写文件</h1><p>GFS写文件的过程会更加复杂且有趣。从应用程序的角度来看，写文件和读文件的接口是非常类似的，它们都是调用GFS的库。<strong>写文件是，应用程序会告诉库函数说，我想对这个文件名的文件在这个数据段写入当前存在buffer中的数据</strong>。稍微收敛一下，我只想讨论数据的追加。所以我会限制这里的客户端接口，客户端（也就是应用程序）只能说，<strong>我想把buffer中的数据，追加到这个文件名对应的文件中</strong>。这就是GFS论文中讨论的记录追加（Record Append）。所以，再次描述一下，<strong>对于写文件，客户端会向Master节点发送请求说：我想向这个文件名对应的文件追加数据，请告诉我文件中最后一个Chunk的位置</strong>。</p>
<h2 id="读的时候，哪一个chunk都可以，只要是新的，但是写的时候要主chunk"><a href="#读的时候，哪一个chunk都可以，只要是新的，但是写的时候要主chunk" class="headerlink" title="读的时候，哪一个chunk都可以，只要是新的，但是写的时候要主chunk"></a>读的时候，哪一个chunk都可以，只要是新的，但是写的时候要主chunk</h2><p>当有多个客户端同时写同一个文件时，一个客户端并不能知道文件究竟有多长。因为如果只有一个客户端在写文件，客户端自己可以记录文件长度，而多个客户端时，一个客户端没法知道其他客户端写了多少。例如，不同客户端写同一份日志文件，没有一个客户端会知道文件究竟有多长，因此也就不知道该往什么样的偏移量，或者说向哪个Chunk去追加数据。这个时候，客户端可以向Master节点查询哪个Chunk服务器保存了文件的最后一个Chunk。</p>
<p>对于读文件来说，可以从任何最新的Chunk副本读取数据，但是对于写文件来说，必须要通过Chunk的主副本（Primary Chunk）来写入。对于某个特定的Chunk来说，在某一个时间点，Master不一定指定了Chunk的主副本。所以，写文件的时候，需要考虑Chunk的主副本不存在的情况</p>
<h2 id="master找到主chunk"><a href="#master找到主chunk" class="headerlink" title="master找到主chunk"></a>master找到主chunk</h2><p>对于Master节点来说，<strong>如果发现Chunk的主副本不存在，Master会找出所有存有Chunk最新副本的Chunk服务器</strong>。如果你的一个系统已经运行了很长时间，那么有可能某一个Chunk服务器保存的Chunk副本是旧的，比如说还是昨天或者上周的。导致这个现象的原因可能是服务器因为宕机而没有收到任何的更新。所以，<strong>Master节点需要能够在Chunk的多个副本中识别出，哪些副本是新的，哪些是旧的</strong>。所以第一步是，找出新的Chunk副本。这一切都是在Master节点发生，因为，现在是客户端告诉Master节点说要追加某个文件，Master节点需要告诉客户端向哪个Chunk服务器（也就是Primary Chunk所在的服务器）去做追加操作。所以，Master节点的部分工作就是弄清楚在追加文件时，客户端应该与哪个Chunk服务器通信。</p>
<p><strong>每个Chunk可能同时有多个副本，最新的副本是指，副本中保存的版本号与Master中记录的Chunk的版本号一致</strong>。Chunk副本中的版本号是由Master节点下发的，所以Master节点知道，对于一个特定的Chunk，哪个版本号是最新的。<strong>这就是为什么Chunk的版本号在Master节点上需要保存在磁盘这种非易失的存储中的原因</strong>（见3.4），因为如果版本号在故障重启中丢失，且部分Chunk服务器持有旧的Chunk副本，这时，Master是没有办法区分哪个Chunk服务器的数据是旧的，哪个Chunk服务器的数据是最新的。</p>
<blockquote>
<p>学生提问：<strong>为什么不将所有Chunk服务器上保存的最大版本号作为Chunk的最新版本号</strong>？</p>
<p>Robert教授：当Master重启时，无论如何都需要与所有的Chunk服务器进行通信，因为Master需要确定哪个Chunk服务器存了哪个Chunk。你可能会想到，Master可以将所有Chunk服务器上的Chunk版本号汇总，找出里面的最大值作为最新的版本号。<strong>如果所有持有Chunk的服务器都响应了，那么这种方法是没有问题的。但是存在一种风险，当Master节点重启时，可能部分Chunk服务器离线或者失联或者自己也在重启，从而不能响应Master节点的请求。</strong>所以，Master节点可能只能获取到持有旧副本的Chunk服务器的响应，而持有最新副本的Chunk服务器还没有完成重启，或者还是离线状态（这个时候Master能找到的Chunk最大版本明显不对）。</p>
<p>当<strong>Master找不到持有最新Chunk的服务器时该怎么办</strong>？Master节点会定期与Chunk服务器交互来查询它们持有什么样版本的Chunk。假设Master保存的Chunk版本是17，但是又没有找到存储了版本号是17的Chunk服务器，<strong>那么有两种可能：要么Master会等待，并不响应客户端的请求；要么会返回给客户端说，我现在还不知道Chunk在哪，过会再重试吧</strong>。比如说机房电源故障了，所有的服务器都崩溃了，我们正在缓慢的重启。Master节点和一些Chunk服务器可能可以先启动起来，一些Chunk服务器可能要5分钟以后才能重启，这种场景下，我们需要等待，甚至可能是永远等待，因为你不会想使用Chunk的旧数据。</p>
<p>所以，总的来说，在重启时，因为Master从磁盘存储的数据知道Chunk对应的最新版本，Master节点会整合具有最新版本Chunk的服务器。每个Chunk服务器会记住本地存储Chunk对应的版本号，当Chunk服务器向Master汇报时，就可以说，我有这个Chunk的这个版本。而Master节点就可以忽略哪些版本号与已知版本不匹配的Chunk服务器。</p>
</blockquote>
<p>回到之前的话题，当客户端想要对文件进行追加，但是又不知道文件尾的Chunk对应的Primary在哪时，Master会等所有存储了最新Chunk版本的服务器集合完成，然后挑选一个作为Primary，其他的作为Secondary。</p>
<p>之后，Master会增加版本号，并将版本号写入磁盘，这样就算故障了也不会丢失这个数据。</p>
<p>接下来，Master节点会向Primary和Secondary副本对应的服务器发送消息并告诉它们，谁是Primary，谁是Secondary，Chunk的新版本是什么。Primary和Secondary服务器都会将版本号存储在本地的磁盘中。这样，当它们因为电源故障或者其他原因重启时，它们可以向Master报告本地保存的Chunk的实际版本号</p>
<h2 id="出现chunk反馈版本号比master高的情况"><a href="#出现chunk反馈版本号比master高的情况" class="headerlink" title="出现chunk反馈版本号比master高的情况"></a>出现chunk反馈版本号比master高的情况</h2><blockquote>
<p>学生提问：如果Chunk服务器上报的版本号高于Master存储的版本号会怎么样？</p>
<p>Robert教授：这个问题很好。我不知道答案，不过论文中有一些线索。其实刚刚我的介绍有一些错误，我认为你的问题让我明白了一些事情。GFS论文说，如果Master节点重启，并且与Chunk服务器交互，同时一个Chunk服务器重启，并上报了一个比Master记住的版本更高的版本。Master会认为它在分配新的Primary服务器时出现了错误，并且会使用这个更高的版本号来作为Chunk的最新版本号。</p>
<p>当Master向Primary和Secondary发送完消息之后就崩溃了，可能会出现上面这种情况。为了让Master能够处理这种情况，Master在发送完消息之后，需要将Chunk的最新版本写入到磁盘中。这里的写入或许需要等到Primary和Secondary返回确认消息之后。</p>
<p>Robert教授：我不认为这行得通。因为存在这种可能性，当Master节点重启时，存储了Chunk最新版本号的Chunk服务器是离线状态。这种情况下，我们不希望Master在重启时不知道当前的版本号，因为那样的话，Master就会认为当前发现的最高版本号是当前版本号，但是（由于有最新版本号的Chunk服务器还是离线状态）发现的最高版本号可能是个旧版本号。</p>
<p>我（Robert教授）之前没太关注这块，所以我也不太确定Master究竟是先写本地磁盘中的版本号，然后再通知Primary和Secondary，还是反过来。但是不管怎么样，Master会更新自己的版本号，并通知Primary和Secondary说，你们现在是Primary和Secondary，并且版本号更新了。</p>
</blockquote>
<p>所以，现在我们有了一个Primary，它可以接收来自客户端的写请求，并将写请求应用在多个Chunk服务器中。之所以要管理Chunk的版本号，是因为这样Master可以将实际更新Chunk的能力转移给Primary服务器。并且在将版本号更新到Primary和Secondary服务器之后，如果Master节点故障重启，还是可以在相同的Primary和Secondary服务器上继续更新Chunk。</p>
<p>现在，Master节点通知Primary和Secondary服务器，你们可以修改这个Chunk。它还给Primary一个租约，这个租约告诉Primary说，在接下来的60秒中，你将是Primary，60秒之后你必须停止成为Primary。这种机制可以确保我们不会同时有两个Primary，我们之后会再做讨论（3.7的问答中有一个专门的问题讨论）</p>
<h2 id="客户端和chunk服务器联系，写入数据"><a href="#客户端和chunk服务器联系，写入数据" class="headerlink" title="客户端和chunk服务器联系，写入数据"></a>客户端和chunk服务器联系，写入数据</h2><p>我们现在来看GFS论文的图2。假设现在Master节点告诉客户端谁是Primary，谁是Secondary，GFS提出了一种聪明的方法来实现写请求的执行序列。客户端会将要追加的数据发送给Primary和Secondary服务器，这些服务器会将数据写入到一个临时位置。所以最开始，这些数据不会追加到文件中。当所有的服务器都返回确认消息说，已经有了要追加的数据，客户端会向Primary服务器发送一条消息说，你和所有的Secondary服务器都有了要追加的数据，现在我想将这个数据追加到这个文件中。Primary服务器或许会从大量客户端收到大量的并发请求，Primary服务器会以某种顺序，一次只执行一个请求。<strong>对于每个客户端的追加数据请求（也就是写请求），Primary会查看当前文件结尾的Chunk，并确保Chunk中有足够的剩余空间，然后将客户端要追加的数据写入Chunk的末尾。并且，Primary会通知所有的Secondary服务器也将客户端要追加的数据写入在它们自己存储的Chunk末尾。这样，包括Primary在内的所有副本，都会收到通知将数据追加在Chunk的末尾。</strong></p>
<h2 id="确保primary-chunk和secondary-chunk的一致性"><a href="#确保primary-chunk和secondary-chunk的一致性" class="headerlink" title="确保primary chunk和secondary chunk的一致性"></a>确保primary chunk和secondary chunk的一致性</h2><p>但是对于Secondary服务器来说，它们可能可以执行成功，也可能会执行失败，比如说磁盘空间不足，比如说故障了，比如说Primary发出的消息网络丢包了。如果Secondary实际真的将数据写入到了本地磁盘存储的Chunk中，它会回复“yes”给Primary。如果所有的Secondary服务器都成功将数据写入，并将“yes”回复给了Primary，并且Primary也收到了这些回复。Primary会向客户端返回写入成功。如果至少一个Secondary服务器没有回复Primary，或者回复了，但是内容却是：抱歉，一些不好的事情发生了，比如说磁盘空间不够，或者磁盘故障了，Primary会向客户端返回写入失败。</p>
<p>GFS论文说，如果客户端从Primary得到写入失败，那么客户端应该重新发起整个追加过程。客户端首先会重新与Master交互，找到文件末尾的Chunk；之后，客户端需要重新发起对于Primary和Secondary的数据追加操作。</p>
<blockquote>
<p>学生提问：写文件失败之后Primary和Secondary服务器上的状态如何恢复？</p>
<p>Robert教授：你的问题是，Primary告诉所有的副本去执行数据追加操作，某些成功了，某些没成功。如果某些副本没有成功执行，Primary会回复客户端说执行失败。之后客户端会认为数据没有追加成功。但是实际上，部分副本还是成功将数据追加了。所以现在，一个Chunk的部分副本成功完成了数据追加，而另一部分没有成功，<strong>这种状态是可接受的，没有什么需要恢复，这就是GFS的工作方式。</strong>(primary是肯定写成功的，不然就不会分发消息，所以可以根据primary来计算offset，这样就是浪费一些空间)</p>
<p>学生提问：写文件失败之后，读Chunk数据会有什么不同？</p>
<p>Robert教授：如果写文件失败之后，一个客户端读取相同的Chunk，客户端可能可以读到追加的数据，也可能读不到，取决于客户端读的是Chunk的哪个副本。</p>
<p>如果一个客户端发送写文件的请求，并且得到了表示成功的回复，那意味着所有的副本都在相同的位置追加了数据。如果客户端收到了表示失败的回复，那么意味着0到多个副本实际追加了数据，其他的副本没有追加上数据。所以这时，有些副本会有追加的数据，有些副本没有。这时，取决于你从哪个副本读数据，有可能读到追加的新数据，也有可能读不到。</p>
<p>学生提问：可不可以通过版本号来判断副本是否有之前追加的数据？</p>
<p>Robert教授：所有的Secondary都有相同的版本号。版本号只会在Master指定一个新Primary时才会改变。通常只有在原Primary发生故障了，才会指定一个新的Primary。所以，副本（参与写操作的Primary和Secondary）都有相同的版本号，你没法通过版本号来判断它们是否一样，或许它们就是不一样的（取决于数据追加成功与否）。</p>
<p>这么做的理由是，当Primary回复“no”给客户端时，客户端知道写入失败了，之后客户端的GFS库会重新发起追加数据的请求，直到最后成功追加数据。成功了之后，追加的数据会在所有的副本中相同位置存在。在那之前，追加的数据只会在部分副本中存在。</p>
<p>学生提问：<strong>客户端将数据拷贝给多个副本会不会造成瓶颈</strong>？</p>
<p>Robert教授：这是一个好问题。考虑到底层网络，写入文件数据的具体传输路径可能会非常重要。当论文第一次提到这一点时，它说客户端会将数据发送给每个副本。实际上，之后，论文又改变了说法，说客户端只会将数据发送给离它最近的副本，之后那个副本会将数据转发到另一个副本，以此类推形成一条链，直到所有的副本都有了数据。这样一条数据传输链可以在数据中心内减少跨交换机传输（否则，所有的数据吞吐都在客户端所在的交换机上）。</p>
<p>学生提问：什么时候版本号会增加？</p>
<p>Robert教授：版本号只在Master节点认为Chunk没有Primary时才会增加。在一个正常的流程中，如果对于一个Chunk来说，已经存在了Primary，那么Master节点会记住已经有一个Primary和一些Secondary，Master不会重新选择Primary，也不会增加版本号。它只会告诉客户端说这是Primary，并不会变更版本号。</p>
<p>学生提问：如果写入数据失败了，不是应该先找到问题在哪再重试吗？</p>
<p>Robert教授：我认为这是个有趣的问题。当Primary向客户端返回写入失败时，你或许会认为一定是哪里出错了，在修复之前不应该重试。实际上，就我所知，论文里面在重试追加数据之前没有任何中间操作。因为，错误可能就是网络数据的丢失，这时就没什么好修复的，网络数据丢失了，我们应该重传这条网络数据。客户端重新尝试追加数据可以看做是一种复杂的重传数据的方法。或许对于大多数的错误来说，我们不需要修改任何东西，同样的Primary，同样的Secondary，客户端重试一次或许就能正常工作，因为这次网络没有丢包。</p>
<p>但是如果是某一个Secondary服务器出现严重的故障，那问题变得有意思了。我们希望的是，Master节点能够重新生成Chunk对应的服务器列表，将不工作的Secondary服务器剔除，再选择一个新的Primary，并增加版本号。如果这样的话，我们就有了一组新的Primary，Secondary和版本号，同时，我们还有一个不太健康的Secondary，它包含的是旧的副本和旧的版本号，正是因为版本号是旧的，Master永远也不会认为它拥有新的数据。但是，论文中没有证据证明这些会立即发生。论文里只是说，客户端重试，并且期望之后能正常工作。最终，Master节点会ping所有的Chunk服务器，如果Secondary服务器挂了，Master节点可以发现并更新Primary和Secondary的集合，之后再增加版本号。但是这些都是之后才会发生（而不是立即发生）。</p>
<p>学生提问：如果Master节点发现Primary挂了会怎么办？</p>
<p>Robert教授：可以这么回答这个问题。在某个时间点，Master指定了一个Primary，之后Master会一直通过定期的ping来检查它是否还存活。因为如果它挂了，Master需要选择一个新的Primary。Master发送了一些ping给Primary，并且Primary没有回应，你可能会认为Master会在那个时间立刻指定一个新的Primary。但事实是，这是一个错误的想法。为什么是一个错误的想法呢？因为可能是网络的原因导致ping没有成功，所以有可能Primary还活着，但是网络的原因导致ping失败了。但同时，Primary还可以与客户端交互，如果Master为Chunk指定了一个新的Primary，那么就会同时有两个Primary处理写请求，这两个Primary不知道彼此的存在，会分别处理不同的写请求，最终会导致有两个不同的数据拷贝。这被称为脑裂（split-brain）。</p>
<p>脑裂是一种非常重要的概念，我们会在之后的课程中再次介绍它（详见6.1），它通常是由网络分区引起的。比如说，Master无法与Primary通信，但是Primary又可以与客户端通信，这就是一种网络分区问题。网络故障是这类分布式存储系统中最难处理的问题之一。</p>
<p>所以，我们想要避免错误的为同一个Chunk指定两个Primary的可能性。Master采取的方式是，当指定一个Primary时，为它分配一个租约，Primary只在租约内有效。Master和Primary都会知道并记住租约有多长，当租约过期了，Primary会停止响应客户端请求，它会忽略或者拒绝客户端请求。因此，如果Master不能与Primary通信，并且想要指定一个新的Primary时，Master会等到前一个Primary的租约到期。这意味着，Master什么也不会做，只是等待租约到期。租约到期之后，可以确保旧的Primary停止了它的角色，这时Master可以安全的指定一个新的Primary而不用担心出现这种可怕的脑裂的情况。</p>
<p>学生提问：为什么立即指定一个新的Primary是坏的设计？既然客户端总是先询问Master节点，Master指定完Primary之后，将新的Primary返回给客户端不行吗？</p>
<p>Robert教授：因为客户端会通过缓存提高效率，客户端会在短时间缓存Primary的身份信息（这样，客户端就不用每次都会向Master请求Primary信息）。即使没有缓存，也可能出现这种情况，客户端向Master节点查询Primary信息，Master会将Primary信息返回，这条消息在网络中传播。之后Master如果发现Primary出现故障，并且立刻指定一个新的Primary，同时向新的Primary发消息说，你是Primary。Master节点之后会向其他查询Primary的客户端返回这个新的Primary。而前一个Primary的查询还在传递过程中，前一个客户端收到的还是旧的Primary的信息。如果没有其他的更聪明的一些机制，前一个客户端是没办法知道收到的Primary已经过时了。如果前一个客户端执行写文件，那么就会与后来的客户端产生两个冲突的副本。</p>
<p>学生提问：如果是对一个新的文件进行追加，那这个新的文件没有副本，会怎样？</p>
<p>Robert教授：你会按照黑板上的路径（见3.6）再执行一遍。Master会从客户端收到一个请求说，我想向这个文件追加数据。我猜，Master节点会发现，该文件没有关联的Chunk。Master节点或许会通过随机数生成器创造一个新的Chunk ID。之后，Master节点通过查看自己的Chunk表单发现，自己其实也没有Chunk ID对应的任何信息。之后，Master节点会创建一条新的Chunk记录说，我要创建一个新的版本号为1，再随机选择一个Primary和一组Secondary并告诉它们，你们将对这个空的Chunk负责，请开始工作。论文里说，每个Chunk默认会有三个副本，所以，通常来说是一个Primary和两个Secondary。</p>
</blockquote>
<h1 id="GFS的一致性"><a href="#GFS的一致性" class="headerlink" title="GFS的一致性"></a>GFS的一致性</h1><p>在GFS的这种工作方式下，如果Primary返回写入成功，那么一切都还好，如果Primary返回写入失败，就不是那么好了。Primary返回写入失败会导致不同的副本有完全不同的数据。</p>
<blockquote>
<p>学生提问：客户端重新发起写入的请求时从哪一步开始重新执行的？</p>
<p>Robert教授：根据我从论文中读到的内容，（当写入失败，客户端重新发起写入数据请求时）客户端会从整个流程的最开始重发。客户端会再次向Master询问文件最后一个Chunk是什么，因为文件可能因为其他客户端的数据追加而发生了改变。</p>
<p>学生提问：为什么GFS要设计成多个副本不一致？</p>
<p>Robert教授：我不明白GFS设计者为什么要这么做。GFS可以设计成多个副本是完全精确同步的，你们在lab2和lab3会设计一个系统，其中的副本是同步的。并且你们也会知道，为了保持同步，你们要使用各种各样的技术。如果你们想要让副本保持同步，其中一条规则就是你们不能允许这种只更新部分服务器的不完整操作。这意味着，你必须要有某种机制，即使客户端挂了，系统仍然会完成请求。如果这样的话，GFS中的Primary就必须确保每一个副本都得到每一条消息。</p>
<p>学生提问：如果第一次写B失败了，C应该在B的位置吧？</p>
<p>Robert教授：实际上并没有。实际上，Primary将C添加到了Chunk的末尾，在B第一次写入的位置之后。我认为这么做的原因是，当写C的请求发送过来时，Primary实际上可能不知道B的命运是什么。因为我们面对的是多个客户端并发提交追加数据的请求，为了获得高性能，你会希望Primary先执行追加数据B的请求，一旦获取了下一个偏移量，再通知所有的副本执行追加数据C的请求，这样所有的事情就可以并行的发生。</p>
<p>也可以减慢速度，Primary也可以判断B已经写入失败了，然后再发一轮消息让所有副本撤销数据B的写操作，但是这样更复杂也更慢。</p>
</blockquote>
<p>GFS这样设计的理由是足够的简单，但是同时也给应用程序暴露了一些奇怪的数据。这里希望为应用程序提供一个相对简单的写入接口，但应用程序需要容忍读取数据的乱序。如果应用程序不能容忍乱序，应用程序要么可以通过在文件中写入序列号，这样读取的时候能自己识别顺序，要么如果应用程序对顺序真的非常敏感那么对于特定的文件不要并发写入。例如，对于电影文件，你不会想要将数据弄乱，当你将电影写入文件时，你可以只用一个客户端连续顺序而不是并发的将数据追加到文件中。</p>
<ul>
<li>你可能需要让Primary来探测重复的请求，这样第二个写入数据B的请求到达时，Primary就知道，我们之前看到过这个请求，可能执行了也可能没执行成功。Primay要尝试确保B不会在文件中出现两次。所以首先需要的是探测重复的能力。</li>
<li>对于Secondary来说，如果Primay要求Secondary执行一个操作，Secondary必须要执行而不是只返回一个错误给Primary。对于一个严格一致的系统来说，是不允许Secondary忽略Primary的请求而没有任何补偿措施的。所以我认为，Secondary需要接受请求并执行它们。如果Secondary有一些永久性故障，例如磁盘被错误的拔出了，你需要有一种机制将Secondary从系统中移除，这样Primary可以与剩下的Secondary继续工作。但是GFS没有做到这一点，或者说至少没有做对。</li>
<li>当Primary要求Secondary追加数据时，直到Primary确信所有的Secondary都能执行数据追加之前，Secondary必须小心不要将数据暴露给读请求。所以对于写请求，你或许需要多个阶段。在第一个阶段，Primary向Secondary发请求，要求其执行某个操作，并等待Secondary回复说能否完成该操作，这时Secondary并不实际执行操作。在第二个阶段，如果所有Secondary都回复说可以执行该操作，这时Primary才会说，好的，所有Secondary执行刚刚你们回复可以执行的那个操作。这是现实世界中很多强一致系统的工作方式，这被称为两阶段提交（Two-phase commit）。</li>
<li>另一个问题是，当Primary崩溃时，可能有一组操作由Primary发送给Secondary，Primary在确认所有的Secondary收到了请求之前就崩溃了。当一个Primary崩溃了，一个Secondary会接任成为新的Primary，但是这时，新Primary和剩下的Secondary会在最后几个操作有分歧，因为部分副本并没有收到前一个Primary崩溃前发出的请求。所以，新的Primary上任时，需要显式的与Secondary进行同步，以确保操作历史的结尾是相同的。</li>
<li>最后，时不时的，Secondary之间可能会有差异，或者客户端从Master节点获取的是稍微过时的Secondary。系统要么需要将所有的读请求都发送给Primary，因为只有Primary知道哪些操作实际发生了，要么对于Secondary需要一个租约系统，就像Primary一样，这样就知道Secondary在哪些时间可以合法的响应客户端。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/the-google-file-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/the-google-file-system/" class="post-title-link" itemprop="url">The Google File System</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 08:46:36" itemprop="dateCreated datePublished" datetime="2021-04-25T08:46:36+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:47:40" itemprop="dateModified" datetime="2021-07-07T13:47:40+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
                </span>
            </span>

          
            <span id="/2021/04/25/the-google-file-system/" class="post-meta-item leancloud_visitors" data-flag-title="The Google File System" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/25/the-google-file-system/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/25/the-google-file-system/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a>原文地址</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87314382">https://zhuanlan.zhihu.com/p/87314382</a></p>
<h1 id="本文"><a href="#本文" class="headerlink" title="本文"></a>本文</h1><p>google file system （GFS）是一种适用于大型分布式数据密集型应用的 可扩展分布式文件系统。在大量普通机器上运行并提供容错能力，并为大量客户端提供高性能。</p>
<h1 id="1-GFS设计原理"><a href="#1-GFS设计原理" class="headerlink" title="1 GFS设计原理"></a>1 GFS设计原理</h1><ul>
<li><p><strong>节点失效是常态</strong>。系统由成百上千个普通机器组成，大量用户同时进行访问，这使得节点很容易因程序bug 磁盘故障 内存故障等原因失效。因此，GFS必须能够持续的监控自身状态，进行异常检测，同时具有很高的<strong>容错</strong>性，可以自动的从节点失效中快速回复。</p>
</li>
<li><p><strong>存储内容以大文件为主</strong>。系统存储上百万个大文件，每个文件通常几百MB或几GB。系统需要支持小文件，但不需要对其进行优化</p>
</li>
<li><p>系统主要文件操作为<strong>大容量连续读</strong>、<strong>小容量随机读</strong>以及<strong>追加连续写。</strong></p>
</li>
<li><p>系统应该支持<strong>原子的文件追加</strong>操作，使得大量用户可以并行追加文件，而不需要额外的加锁机制。在Goole应用场景中，这些文件常用于生产者-消费者队列或者多路归并。</p>
</li>
<li><p>系统的<strong>高吞吐量比低延时更重要</strong></p>
<h1 id="2-GFS集群架构"><a href="#2-GFS集群架构" class="headerlink" title="2 GFS集群架构"></a>2 GFS集群架构</h1></li>
</ul>
<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210425155828096.png" alt="image-20210425155828096"></p>
<p>一个GFS集群由一个<strong>Master</strong>节点和若干个<strong>Chunk Server</strong>节点组成，可以被若干个<strong>客户端</strong>访问。每个节点作为用户级进程运行在Linux机器上。</p>
<p>在存储文件时，GFS会把文件切分成64MB的<strong>Chunk</strong>进行存储。Chunk由一个Master分配的不可改变且全局唯一的64位Chunk句柄进行标识。Chunk Server在本地磁盘上存储Chunk，通过指定Chunk句柄和字节范围读取或写入Chunk。为了保证可靠性，每一个Chunk会被备份到多个Chunk Server上，通常情况下存储三份Replica。</p>
<blockquote>
<p>那么GFS的master把本身是不是不存文件内容</p>
</blockquote>
<p>Master负责维护整个集群的元数据，包括文件和Chunk的命名空间、访问控制信息、文件与Chunk的映射和Chunk Replica的位置信息。此外，Master还负责Chunk的租期管理、回收和迁移。Master也会周期地通过心跳包和Chunk Server进行通信，以此收集Chunk Server的状态并向其发送指令。</p>
<p>客户端与Master交互获得集群的元数据。当客户端需要进行数据读写时，不会通过Master直接进行，而是询问Master应该与哪些Chunk Server通信，然后直接与Chunk Server通信进行数据读写，以此避免Master成为整个集群数据传输的瓶颈，同时，客户端会在一定时间内缓存Chunk Server信息，后续操作可以直接与Chunk Server进行通信。</p>
<h1 id="3-chunk大小的选取"><a href="#3-chunk大小的选取" class="headerlink" title="3 chunk大小的选取"></a>3 chunk大小的选取</h1><p>通常情况下，Chunk大小为64MB，这比典型的文件系统block大小大得多，可以通过惰性空间分配策略，来避免因内部碎片造成的空间浪费。</p>
<p>选择较大的Chunk具有以下优点：</p>
<ul>
<li><strong>减少客户端与Master的通信次数</strong>，因为对同一个Chunk的多次读写只需要请求一次Chunk信息。</li>
<li>增大客户端操作落到同一个Chunk上的概率。由于客户端可以对一个Chunk进行多次操作，因此可以通过与Chunk Server保持持久的TCP连接来<strong>减少网络负载</strong>。</li>
<li><strong>减少Master保存的元数据大小</strong>，使得可以把元数据全部放在内存中（后面会讲到这样做的好处）。</li>
</ul>
<p>不过，较大的Chunk会使得小文件占据额外的存储空间。此外，小文件通常只会占据一个Chunk，当大量客户端访问这个小文件时，这个Chunk容易成为系统的负载热点。可以通过增加这类文件的Replica数量来进行负载均衡，更好的方法是允许客户端从其它客户端读取数据</p>
<h1 id="4-GFS元数据管理"><a href="#4-GFS元数据管理" class="headerlink" title="4 GFS元数据管理"></a>4 GFS元数据管理</h1><p>GFS元数据全部保存在Master的内存中，主要包括以下三类信息：</p>
<ul>
<li>文件和chunk的命名空间 （本地磁盘）</li>
<li>文件与chunk的映射 （本地磁盘）</li>
<li>chunk replica的位置信息 （内存）</li>
</ul>
<p>元数据保存在Master内存中使得Master要对元数据作出变更变得极为容易；同时，这也使得Master可以简单高效地周期性扫描整个集群的状态，以实现Chunk回收、迁移、均衡等操作。唯一的不足在于这使得整个集群所能拥有的Chunk数量受限于Master的内存大小，然而实际中不必担心这种情况，因为一个64MB的Chunk，只需要保存64KB的元数据，况且提高Master内存容量的成本也很低。</p>
<p>Master会把前两类信息以日志形式持久化存储在Master的本地磁盘上，并在在其他机器上备份，但是不会持久化保存Chunk Replica的位置信息，而是在集群启动时由Master询问各个Chunk Server其当前所有的Repica。这样做可以省去由于Chunk Server离开集群、更改名字、重启等原因的Master与Chunk Server的同步问题。此后，Master通过心跳包来监控Chunk Server的状态并更新内存中的信息。</p>
<p>为了保证元数据的可用性，Master在对元数据做任何操作前对会用<strong>先写日志</strong>的形式将操作进行记录，只有当日志写入完成后才会响应客户端的请求，而这些日志也会备份到多个机器上。日志不仅是元数据的唯一持久化记录，也是定义操作执行顺序的时间线。文件、Chunk和他们的版本信息都由他们的创建时间唯一的永久的标识。</p>
<h1 id="5-namespace管理"><a href="#5-namespace管理" class="headerlink" title="5 namespace管理"></a>5 namespace管理</h1><p>在前面我们已经了解到，Namespace作为 GFS 元信息的一部分会被维持在Master的内存中，由 Master负责管理。在逻辑上，Master并不会根据文件与目录的关系以分层的结构来管理这部分数据，而是单纯地将其表示为从完整路径名到对应文件元数据的映射表，并在路径名上应用前缀压缩以减少内存占用。</p>
<p>为了管理来自不同客户端的并发请求对Namespace的修改，Master 、会为Namespace中的每个文件和目录都分配一个读写锁（Read-Write Lock）。由此，对不同Namespace区域的并发请求便可以同时进行。</p>
<p>所有Master操作在执行前都会需要先获取一系列的锁：通常，当操作涉及某个路径 /d1/d2/…/dn/leaf时，Master会需要先获取从/d1、/d1/d2到/d1/d2/…/dn的读锁，然后再根据操作的类型获取 /d1/d2/…/dn/lead的读锁或写锁。获取父目录的读锁是为了避免父目录在此次操作执行的过程中被重命名或删除。</p>
<p>由于大量的读写锁可能会造成较高的内存占用，这些锁会在实际需要时才进行创建，并在不再需要时被销毁。此外，所有的锁获取操作也会按照一个相同的顺序进行，以避免发生死锁：锁首先按Namespace树的层级排列，同一层级内则以路径名字典序排列。</p>
<h1 id="6-chunk租约（lease）和变更顺序"><a href="#6-chunk租约（lease）和变更顺序" class="headerlink" title="6 chunk租约（lease）和变更顺序"></a>6 chunk租约（lease）和变更顺序</h1><p>GFS使用租约（lease）机制来保持多个副本间变更顺序的一致性。在客户端对某个Chunk做出变更时，会把该Chunk的Lease交给某个Replica，使其成为Primary：Primary 会负责为这些变更安排一个执行顺序，然后其他Replica便按照相同的顺序执行这些修改。</p>
<p>设计租约机制的目的是为了最小化Master节点的管理负担。Chunk Lease在初始时会有60秒的超时时间。在未超时前，Primary可以向Master申请延长Chunk Lease的时间；必要时Master也可以直接撤回已分配的Chunk Lease。</p>
<h1 id="7-GFS集群常见操作流程"><a href="#7-GFS集群常见操作流程" class="headerlink" title="7 GFS集群常见操作流程"></a>7 GFS集群常见操作流程</h1><h2 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210425171521532.png" alt="image-20210425171521532"></p>
<ol>
<li>客户端向master询问目前哪个chunk server持有该chunk的lease，如果没有一个chunk持有lease，master就选择其中一个replica建立一个lease</li>
<li>master向客户端返回primary和其他replica的位置，客户端缓存这些数据。只有在primary chunk不可用，或者primary chunk回复信息表明它不再持有租约的时候，客户端才需要重新跟master联系。</li>
<li>客户端将数据以任意顺序推送到所有的repica上。chunk server会把这些数据保存到缓冲区中，等待使用。</li>
<li>待所有replica都接受到数据以后，客户端发送写请求给primary。Primary为来自各个客户端的修改操作安排连续的执行序列号，并按顺序应用于其本地存储的数据。</li>
<li>Primary将写请求转发给其他Secondary Replica，Replica按照相同的顺序应用这些修改。</li>
<li>Secondary Replica响应Primary，示意自己已经完成操作。</li>
<li>Primary 响应客户端，并返回该过程中发生的错误（若有）。</li>
</ol>
<p>如果该过程有发生错误，可以认为修改已在 Primary 和部分 Secondary 上成功执行（如果在 Primary 上就出错了，那么写请求不会被转发出去）。此时可以认为此次修改操作没有成功，因为数据会处于<strong>不一致</strong>的状态。此时，客户端会重新尝试执行此次操作。</p>
<p>值得注意的是，这个流程特意将数据流与控制流分开：客户端先向Chunk Server提交数据，再将写请求发往Primary。这么做的好处在于GFS能够更好地利用网络带宽资源</p>
<p>从上述步骤可见，控制流借由写请求从客户端流向Primary，再流向其他Secondary Replica。而数据流以一条数据管道进行传递的：客户端会把数据上传到离自己最近的Replica，该 Replica在接收到数据后再转发给离自己最近的另一个Replica，如此递归直到所有Replica都接收到数据，如此一来便能充分利用每台机器的带宽，避免网络瓶颈和高延时的连接，最小化推送所有数据的延时。</p>
<blockquote>
<p>数据是管道进行，客户端传给距离最近的replica，命令是传给primary</p>
</blockquote>
<h2 id="7-1-文件追加"><a href="#7-1-文件追加" class="headerlink" title="7.1 文件追加"></a>7.1 文件追加</h2><p>文件追加操作的过程和写入的过程相似</p>
<ol>
<li>客户端将数据推送给每个repica，然后将请求发送给primary</li>
<li>primary首先判断将数据追加到chunk后，chunk的大小会不会超出。如果是，那么primary会将当前chunk填充到其大小上限，并通知其他replica执行相同的操作，再响应客户端，通知其应在下一个chunk上重试该操作。</li>
<li>如果数据能够被放入到当前的chunk里，那么primary就会把数据追加到自己的replica中，拿到追加成功返回的偏移量，然后通知其他replica将数据写入到相同位置上。</li>
<li>最后primary把偏移量返回给客户端。</li>
</ol>
<p>当追加操作在部分Replica上执行失败时，Primary会响应客户端，通知它此次操作已失败，客户端便会重试该操作。和写入操作的情形相同，此时已有部分Replica顺利写入这些数据，重新进行数据追加便会导致这一部分的Replica上出现重复数据，不过GFS的一致性模型也确实并未保证每个Replica都会是完全一致的</p>
<p><strong>GFS只确保数据会以一个原子的整体被追加到文件中至少一次。由此我们可以得出，当追加操作成功时，数据必然已被写入到所有Replica的相同偏移位置上</strong>，且每个Replica的长度都至少超出此次追加的记录的尾部，下一次的追加操作必然会被分配一个比该值更大的偏移值，或是被分配到另一个新的块上。</p>
<h2 id="7-2-文件快照"><a href="#7-2-文件快照" class="headerlink" title="7.2 文件快照"></a>7.2 文件快照</h2><p>GFS提供了文件快照功能，可为指定的文件或目录创建一个副本</p>
<p>快照操作的实现采用了写时复制（copy on write）的思想：</p>
<ol>
<li>在master接收都快照请求以后，它首先会撤回这些chunk的lease，以让接下来其他客户端对这些Chunk进行写入时都需要请求Master获知Primary的位置，Master便可利用这个机会创建新的Chunk拷贝。</li>
<li>当Chunk Lease撤回或失效后，Master把操作以日志的方式记录到硬盘上。然后，Master 节点通过复制源文件或者目录的元数据的方式，把这条日志记录的变化反映到保存在内存的状态中。新创建的快照文件和源文件指向完全相同的Chunk。当chunk lease撤回或者失效时，master把操作</li>
<li>当有客户端尝试对这些Chunk进行写入时，Master会注意到这个Chunk的引用计数大于1。此时，Master不会马上响应客户端，而是生成一个Handle，然后通知所有持有这些Chunk的Chunk Server在本地复制出一个新Chunk，Master给新Chunk的一个Replica分配租约，之后响应客户端，客户端得到响应后就可以正常的写这个 Chunk。</li>
</ol>
<h2 id="7-3-文件读取"><a href="#7-3-文件读取" class="headerlink" title="7.3 文件读取"></a>7.3 文件读取</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210426151104175.png" alt="image-20210426151104175"></p>
<ol>
<li>对于指定的文件名和读取位置偏移量，客户端可以根据固定大小的Chunk计算出需要读取文件的Chunk索引。</li>
<li>客户端将文件名和Chunk索引发送给Master，Master返回Chunk句柄以及其所有Replica的位置。客户端会以文件名和Chunk索引为key缓存该数据，当向同一个Chunk读取文件时，如果缓存信息没有过期，则直接与Chunk Server通信。</li>
<li>客户端向最近的replica所在的chunk server发送包含chunk句柄和读取范围的请求</li>
<li>chunk server将数据发送给客户端</li>
</ol>
<h2 id="7-4-文件删除"><a href="#7-4-文件删除" class="headerlink" title="7.4 文件删除"></a>7.4 文件删除</h2><p>当用户对某个文件进行删除时，<strong>GFS 不会立刻删除数据，而是采用惰性策略，在文件和Chunk两个层面上对数据进行移除。</strong></p>
<p>首先，当客户端删除某个文件时，Master像对待其它修改操作一样，立刻把删除操作以日志的方式记录下来。但Master并不会立刻从Namespace中将其删除，而是将该文件重命名为另一个包含删除时时间戳的隐藏的名称。在Master周期扫描Namespace时，它会删除所有三天前的隐藏文件。在文件被彻底从Namespace删除前，客户端仍然可以利用这个重命名后的隐藏名称读取该文件，甚至再次将其重命名以撤销删除操作。</p>
<p>在对Chunk Namespace做类似的常规扫描时，Master找到孤儿Chunk（不被任何文件包含的 Chunk）并删除它们的元数据。在Chunk Server和Master进行的周期心跳通信中，Chunk Server会汇报自己所持有的Chunk Replica，此时Master便会告知Chunk Server哪些Chunk已不存在于元数据中，Chunk Server 则可自行移除对应的Replica。</p>
<p>采用这种删除机制主要有如下三点好处：</p>
<ol>
<li>对于大规模的分布式系统来说，这样的机制更为简单可靠：在Chunk创建时，可能某些Chunk Server创建成功，某些Chunk Server创建失败，这导致某些Chunk Server上可能存在Master不知道的Replica。此外，删除请求可能会发送失败，Master必须重发。相比之下，由Chunk Server主动删除Replica能够以一种更为统一的方式解决以上的问题</li>
<li>这样的删除机制将存储回收过程与Master日常的周期扫描合并在一起，使得这些操作可以以批的形式进行处理，减少资源损耗；此外，这样也得以让Master选择在相对空闲的时候进行这些操作</li>
<li>用户发送删除请求和数据被实际删除之间的延迟也有效避免了用户误操作的问题</li>
</ol>
<p>不过，<strong>如果在存储资源较为稀缺的情况下，用户对存储空间使用的调优可能就会受到该机制的阻碍</strong>。为此，<strong>GFS允许客户端再次删除该文件，以加速从Namespace移除该文件</strong>。除外，<strong>GFS 还可以让用户为Namespace中不同的区域指定不同的备份和删除策略</strong>。</p>
<h1 id="8-replica管理"><a href="#8-replica管理" class="headerlink" title="8 replica管理"></a>8 replica管理</h1><p>chunk的replica位置选取主要有两个目标：最大化数据可靠性和可用性，以及最大化网络带宽利用率。为此，Replica不仅需要被保存在不同的机器上，还需要被保存在不同的机架上，这样如果整个机架不可用了，数据仍然得以存活。如此一来，不同客户端对同一个Chunk进行读取时便可以利用不同机架的出口带宽，但坏处就是进行写入时数据会在不同机架间流转，不过在GFS的设计者看来这是个合理的trade-off。</p>
<p>Chunk Replica可以由Chunk的创建、重新备份和重新负载均衡三种事件创建。</p>
<h2 id="8-1-chunk的创建"><a href="#8-1-chunk的创建" class="headerlink" title="8.1 chunk的创建"></a>8.1 chunk的创建</h2><p>在master创建一个新的chunk时，首先她会需要考虑在哪放置新的replica，master会考虑一下几个因素：</p>
<ol>
<li>Master会倾向于把新的Replica放在磁盘利用率较低的Chunk Server上，以平衡Chunk Server的磁盘利用率</li>
<li>Master会倾向于确保每个Chunk Server上“较新”的Replica不会太多，因为新Chunk的创建意味着接下来会有大量的写入，如果某些Chunk Server上有太多新的Replica，那么写操作压力就会集中在这些Chunk Server上</li>
<li>Master会倾向于把Replica放在不同的机架上</li>
</ol>
<h2 id="8-2-chunk的重备份"><a href="#8-2-chunk的重备份" class="headerlink" title="8.2 chunk的重备份"></a>8.2 chunk的重备份</h2><p>当某个Chunk的Replica数量低于用户指定的阈值时，Master就会对该Chunk进行重备份。这可能是由Chunk Server失效、Chunk Server存储的副本损坏、Chunk Server磁盘损坏或是用户提高了Replica数量阈值所触发。</p>
<p>首先，Master会按照以下因素为每个需要重备份的Chunk安排优先级</p>
<ol>
<li> 该chunk的replica数量与用户指定的replica数量阈值的差距有多大</li>
<li>优先为未删除的文件chunk进行重备份</li>
<li>提高会阻塞用户操作的chunk的优先级</li>
</ol>
<p>Master选取当前拥有最高优先级的Chunk，并指定若干Chunk Server直接从现在已有的Replica上复制数据。Master具体会指定哪些Chunk Server进行复制操作同样会考虑上面提到的几个因素。除外，为了减少重备份对用户使用的影响，Master会限制当前整个集群正在进行的复制操作的数量，同时Chunk Server也会限制复制操作所使用的带宽。</p>
<h2 id="8-3-chunk的负载均衡"><a href="#8-3-chunk的负载均衡" class="headerlink" title="8.3 chunk的负载均衡"></a>8.3 chunk的负载均衡</h2><p>master会周期的检查每个chunk当前在集群内的分布情况，并在必要时迁移部分replica以更好的均衡个节点的磁盘利用率和负载。新replica的位置选取策略和上面提到的大体相同。此外，master还需要移除磁盘占用较高的chunkserver上的replica，以均衡磁盘使用率</p>
<h1 id="9-高可用机制"><a href="#9-高可用机制" class="headerlink" title="9 高可用机制"></a>9 高可用机制</h1><h2 id="9-1-快速恢复"><a href="#9-1-快速恢复" class="headerlink" title="9.1 快速恢复"></a>9.1 快速恢复</h2><p>GFS 的组件被设计为可以在数秒钟内恢复它们的状态并重新启动。GFS的组件实际上并不区分正常退出和异常退出：要关闭某个组件时直接kill进程即可。</p>
<h2 id="9-2-chunk-server"><a href="#9-2-chunk-server" class="headerlink" title="9.2 chunk server"></a>9.2 chunk server</h2><p>作为集群中的Slave角色，Chunk Server失效的几率比Master要大得多。当Chunk Server失效时，其所持有的Replica对应的Chunk的Replica数量便会降低，当Master发现Replica数量低于用户指定阈值时，会进行重备份。</p>
<p>此外，当Chunk Server失效时，用户的写入操作还会不断地进行，那么当Chunk Server重启后，Chunk Server上的Replica便有可能是过期的。为此，Master会为每个Chunk维持一个版本号，以区分正常的和过期的Replica。每当Master将Chunk Lease分配给一个Chunk Server时，Master便会提高Chunk的版本号，并通知其他的Replica更新自己的版本号。如果此时有 Chunk Server失效，那么它上面的Replica的版本号就不会变化。</p>
<p>在 Chunk Server重启时，Chunk Server会向Master汇报自己所持有的Chunk Replica及对应的版本号。如果Master发现某个Replica版本号过低，过期的Replica便会在下一次的Replica回收过程中被移除。此外，Master向客户端返回Replica位置信息时也会返回Chunk当前的版本号，客户端在执行操作时都会验证版本号以确保不会读取到旧的数据。</p>
<h2 id="9-3-master"><a href="#9-3-master" class="headerlink" title="9.3 master"></a>9.3 master</h2><p>Master在对元数据做任何操作前对会用<strong>先写日志</strong>的形式将操作进行记录，只有当日志写入完成后才会响应客户端的请求，而这些日志也会备份到多个机器上。日志只有在写入到本地以及远端备份的持久化存储中才被视为完成写入。</p>
<p>在重新启动时，Master会通过重放已保存的操作记录来恢复自身的状态。为了保证Master能够快速地完成恢复，Master会在日志达到一定大小后为自身的当前状态创建Checkpoint，并删除Checkpoint创建以前的日志，重启时便从最近一次创建的Checkpoint及其后续的日志开始恢复。Checkpoint以B树的形式进行组织，可以直接映射到内存中，且不做其他额外解析的情况下检索其所存储的Namespace，进一步减少Master恢复所需的时间。</p>
<p>为了简化设计，同一时间只会有一个Master起作用。当Master失效时，外部的监控系统会侦测到这一事件，并在其他地方重新启动新的Master进程。</p>
<p>此外，集群还提供具有只读功能的<strong>Shadow Master</strong>。它们会同步Master的状态变更，但有可能延迟若干秒，其主要用于为Master分担读操作的压力。Shadow Master会通过读取 Master 操作日志的某个备份来让自己的状态与Master同步；它也会像Master那样，在启动时轮询各个Chunk Server，获知它们所持有的Chunk Replica信息，并持续监控它们的状态。在Master失效时，Shadow Master仍能为整个集群提供只读功能，在Master因创建和删除副本导致副本位置信息更新时，Shadow Master才和Master通信来更新自身状态。</p>
<h2 id="9-4-数据完整性"><a href="#9-4-数据完整性" class="headerlink" title="9.4 数据完整性"></a>9.4 数据完整性</h2><p>为了保证数据完整，每个Chunk Server都会使用校验和来检测自己保存的数据是否有损坏；在侦测到损坏数据后，Chunk Server可以利用其它Replica来恢复数据。</p>
<p>每个Chunk都分成64KB大小的block。每个block都对应一个32位的校验和。和其它元数据一样，保存在内存和硬盘上，同时也记录操作日志</p>
<p>当进行数据读取操作时，Chunk Server首先会利用校验和检查所需读取的数据是否有发生损坏，如此一来Chunk Server便不会把损坏的数据传递给其他请求发送者，无论它是客户端还是另一个Chunk Server。发现损坏后，Chunk Server会为请求发送者发送一个错误，并向Master告知数据损坏事件。接收到错误后，请求发送者会选择另一个Chunk Server重新发起请求，而Master则会利用另一个Replica为该Chunk进行重备份。当新的Replica创建完成后，Master便会通知该Chunk Server删除这个损坏的Replica。</p>
<p>当进行数据读取操作时，Chunk Server首先会利用校验和检查所需读取的数据是否有发生损坏，如此一来Chunk Server便不会把损坏的数据传递给其他请求发送者，无论它是客户端还是另一个Chunk Server。发现损坏后，Chunk Server会为请求发送者发送一个错误，并向Master告知数据损坏事件。接收到错误后，请求发送者会选择另一个Chunk Server重新发起请求，而Master则会利用另一个Replica为该Chunk进行重备份。当新的Replica创建完成后，Master便会通知该Chunk Server删除这个损坏的Replica。</p>
<h1 id="10-数据一致性"><a href="#10-数据一致性" class="headerlink" title="10 数据一致性"></a>10 数据一致性</h1><p>首先，命名空间完全由单节点Master管理在其内存中，这部分数据的修改可以通过让Master 为其添加互斥锁来解决并发修改的问题，因此命名空间的数据修改是可以确保完全原子的。</p>
<p>文件的数据修改则相对复杂。在讲述接下来的内容前，首先我们先明确，在文件的某一部分被修改后，它可能进入以下三种状态的其中之一：</p>
<ol>
<li>客户端读取不同的replica时可能会读取到不同的内容，那这部分文件是不一致的（inconsistent）</li>
<li>所有客户端无论读取哪个replica都会读取到相同的内容，那么这部分文件就是一致的 （consistant）</li>
<li>所有客户端都能看到上一次修改的完整内容，且这部分文件是一致的，那么我们说这部分文件是确定的（defined）</li>
</ol>
<p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210426155954776.png" alt="image-20210426155954776"></p>
<p>在修改后，一个文件的当前状态将取决于此次修改的类型以及修改是否成功。具体来说：</p>
<ul>
<li>如果一次写入操作成功且没有与其他并发的写入操作发生重叠，那这部分文件是确定的，也是一致的</li>
<li>如果有若干个写入操作并发的执行成功，那么这部分文件会是一致的但会是不确定的：在这种情况下，客户端所能看到的数据通常不会直接体现出其中的任何一次修改</li>
<li>失败的写入操作会让文件进入不一致状态</li>
</ul>
<p>GFS 支持的文件数据修改数据包括两种：<strong>指定偏移值的数据写入（Write）</strong>以及<strong>数据追加（Record Append）</strong>。当写入时，指定的数据会被直接写入到客户端指定的偏移位置中，覆盖原有的数据。GFS并未为该操作提供太多的一致性保证：如果不同的客户端并发地写入同一块文件区域，操作完成后这块区域的数据可能由各次写入的数据碎片所组成，即进入<strong>不确定</strong>的状态。</p>
<p>经过了一系列的成功的修改操作之后，GFS 确保被修改的文件区域是已确定的，并且包含最后一次修改操作写入的数据。GFS通过以下措施确保上述行为：(a)对Chunk的所有副本的修改操作顺序一致，(b)使用Chunk的版本号来检测Replica是否因为它所在的Chunk Server宕机而错过了修改操作而导致其失效。失效的Replica不会再进行任何修改操作，Master Server也不再返回这个Chunk Replica的位置信息给客户端。它们会被垃圾回收系统尽快回收。</p>
<h1 id="11-对应用的影响"><a href="#11-对应用的影响" class="headerlink" title="11 对应用的影响"></a>11 对应用的影响</h1><p>GFS的一致性模型是相对松散的，这要求上层应用在使用GFS时能够适应GFS所提供的一致性语义。</p>
<p>GFS 的一致性模型是相对松散的，这就要求上层应用在使用GFS时能够适应GFS所提供的一致性语义。简单来讲，上层应用可以通过两种方式来做到这一点：更多使用追加操作而不是覆写操作；写入包含校验信息的数据。</p>
<p>GFS针对追加操作做出了显著的优化，这使得这种数据写入方式的性能更高，而且也能提供更强的一致性语义。尽管如此，追加操作at least once的特性仍使得客户端可能读取到填充或是重复数据，这要求客户端能够容忍这部分无效数据。一种可行的做法是在写入时为所有记录写入各自的校验和，并在读取时进行校验，以剔除无效的数据；如果客户端无法容忍重复数据，客户端也可以在写入时为每条记录写入唯一的标识符，以便在读取时通过标识符去除重复的数据。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/20/%E5%93%88%E5%B8%8C%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/20/%E5%93%88%E5%B8%8C%E8%A1%A8/" class="post-title-link" itemprop="url">哈希表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-20 21:46:36" itemprop="dateCreated datePublished" datetime="2021-04-20T21:46:36+08:00">2021-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:48:06" itemprop="dateModified" datetime="2021-07-07T13:48:06+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
                </span>
            </span>

          
            <span id="/2021/04/20/%E5%93%88%E5%B8%8C%E8%A1%A8/" class="post-meta-item leancloud_visitors" data-flag-title="哈希表" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/20/%E5%93%88%E5%B8%8C%E8%A1%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/20/%E5%93%88%E5%B8%8C%E8%A1%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="字母异位词分组"><a href="#字母异位词分组" class="headerlink" title="字母异位词分组"></a>字母异位词分组</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210420092704227.png" alt="image-20210420092704227"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;String&gt;&gt; groupAnagrams(String[] strs) &#123;</span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String str : strs) &#123;</span><br><span class="line">            <span class="keyword">char</span>[] array = str.toCharArray();</span><br><span class="line">            Arrays.sort(array);</span><br><span class="line">            String key = <span class="keyword">new</span> String(array);</span><br><span class="line">            List&lt;String&gt; list = map.getOrDefault(key, <span class="keyword">new</span> ArrayList&lt;String&gt;());</span><br><span class="line">            list.add(str);</span><br><span class="line">            map.put(key, list);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;List&lt;String&gt;&gt;(map.values());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/16/sql%E8%AF%AD%E5%8F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="witness">
      <meta itemprop="description" content="learn, love, sport, life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="witness daily">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/16/sql%E8%AF%AD%E5%8F%A5/" class="post-title-link" itemprop="url">mysql语句</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-16 21:46:36" itemprop="dateCreated datePublished" datetime="2021-04-16T21:46:36+08:00">2021-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-07 13:47:34" itemprop="dateModified" datetime="2021-07-07T13:47:34+08:00">2021-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
                </span>
            </span>

          
            <span id="/2021/04/16/sql%E8%AF%AD%E5%8F%A5/" class="post-meta-item leancloud_visitors" data-flag-title="mysql语句" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/16/sql%E8%AF%AD%E5%8F%A5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/16/sql%E8%AF%AD%E5%8F%A5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="组合两个表"><a href="#组合两个表" class="headerlink" title="组合两个表"></a>组合两个表</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p><img src="https://picbed-1259300298.cos.ap-nanjing.myqcloud.com/image-20210417134056121.png" alt="image-20210417134056121"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select FirstName, LastName, City, State</span><br><span class="line">from Person left join Address</span><br><span class="line">on Person.PersonId = Address.PersonId</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">witness</p>
  <div class="site-description" itemprop="description">learn, love, sport, life</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">witness</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'YBrYHUjJcWVmML3kft3FVqWk-gzGzoHsz',
      appKey     : 'HtCkpAB87E1zU1Bmlwp2HFgF',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
